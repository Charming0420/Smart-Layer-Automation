import random
from web3 import Web3
from web3.exceptions import TimeExhausted
import time

from config import my_wallet_address, private_key, cat_ids, cat_ids_B, infura_url, contract_address

web3 = Web3(Web3.HTTPProvider(infura_url))
contract = web3.eth.contract(address=contract_address, abi=[{"inputs":[],"name":"InvalidInitialization","type":"error"},{"inputs":[],"name":"NotInitializing","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":False,"inputs":[{"indexed":False,"internalType":"uint64","name":"version","type":"uint64"}],"name":"Initialized","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":False,"internalType":"uint8","name":"level","type":"uint8"},{"indexed":False,"internalType":"uint256","name":"pointsBalance","type":"uint256"}],"name":"LevelUp","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":True,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"inviter","type":"uint256"}],"name":"acceptPlayDate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"authorisedProxyAddresses","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"canClean","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"canFeed","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"canLevelUp","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"canPlay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"catIds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"catStates","outputs":[{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint16","name":"numFeeds","type":"uint16"},{"internalType":"uint256","name":"lastFeed","type":"uint256"},{"internalType":"uint16","name":"numPlays","type":"uint16"},{"internalType":"uint256","name":"lastPlay","type":"uint256"},{"internalType":"uint16","name":"numCleans","type":"uint16"},{"internalType":"uint256","name":"lastClean","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"cleanCat","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"feedCat","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"offset","type":"uint256"},{"internalType":"uint16","name":"pageSize","type":"uint16"}],"name":"getAllCats","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint256","name":"pointsBalance","type":"uint256"}],"internalType":"struct SmartCatProxyV3.AllCatListItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getCatInfo","outputs":[{"components":[{"components":[{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint16","name":"numFeeds","type":"uint16"},{"internalType":"uint256","name":"lastFeed","type":"uint256"},{"internalType":"uint16","name":"numPlays","type":"uint16"},{"internalType":"uint256","name":"lastPlay","type":"uint256"},{"internalType":"uint16","name":"numCleans","type":"uint16"},{"internalType":"uint256","name":"lastClean","type":"uint256"},{"internalType":"uint256[]","name":"friends","type":"uint256[]"}],"internalType":"struct SmartCatProxyV3.CatState","name":"state","type":"tuple"},{"internalType":"uint256","name":"pointsBalance","type":"uint256"},{"internalType":"uint256","name":"actionLimitReset","type":"uint256"}],"internalType":"struct SmartCatProxyV3.CatInfo","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getCatInfo2","outputs":[{"components":[{"components":[{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint16","name":"numFeeds","type":"uint16"},{"internalType":"uint256","name":"lastFeed","type":"uint256"},{"internalType":"uint16","name":"numPlays","type":"uint16"},{"internalType":"uint256","name":"lastPlay","type":"uint256"},{"internalType":"uint16","name":"numCleans","type":"uint16"},{"internalType":"uint256","name":"lastClean","type":"uint256"},{"internalType":"uint256[]","name":"friends","type":"uint256[]"}],"internalType":"struct SmartCatProxyV3.CatState","name":"state","type":"tuple"},{"internalType":"uint256","name":"pointsBalance","type":"uint256"},{"internalType":"uint256","name":"actionLimitReset","type":"uint256"},{"internalType":"uint16","name":"actionLimitCount","type":"uint16"}],"internalType":"struct SmartCatProxyV3.CatInfo2","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getCatInfo3","outputs":[{"components":[{"components":[{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint16","name":"numFeeds","type":"uint16"},{"internalType":"uint256","name":"lastFeed","type":"uint256"},{"internalType":"uint16","name":"numPlays","type":"uint16"},{"internalType":"uint256","name":"lastPlay","type":"uint256"},{"internalType":"uint16","name":"numCleans","type":"uint16"},{"internalType":"uint256","name":"lastClean","type":"uint256"},{"internalType":"uint256[]","name":"friends","type":"uint256[]"}],"internalType":"struct SmartCatProxyV3.CatState","name":"state","type":"tuple"},{"internalType":"uint256","name":"pointsBalance","type":"uint256"},{"internalType":"uint256","name":"actionLimitReset","type":"uint256"},{"internalType":"uint16","name":"actionLimitCount","type":"uint16"},{"internalType":"bool","name":"canFeed","type":"bool"},{"internalType":"bool","name":"canPlay","type":"bool"},{"internalType":"bool","name":"canClean","type":"bool"},{"internalType":"bool","name":"canLevelUp","type":"bool"}],"internalType":"struct SmartCatProxyV3.CatInfo3","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getCatState","outputs":[{"components":[{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"uint16","name":"numFeeds","type":"uint16"},{"internalType":"uint256","name":"lastFeed","type":"uint256"},{"internalType":"uint16","name":"numPlays","type":"uint16"},{"internalType":"uint256","name":"lastPlay","type":"uint256"},{"internalType":"uint16","name":"numCleans","type":"uint16"},{"internalType":"uint256","name":"lastClean","type":"uint256"},{"internalType":"uint256[]","name":"friends","type":"uint256[]"}],"internalType":"struct SmartCatProxyV3.CatState","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConfig","outputs":[{"internalType":"uint256[3]","name":"","type":"uint256[3]"},{"internalType":"uint16[3]","name":"","type":"uint16[3]"},{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getConfig2","outputs":[{"internalType":"uint256[3]","name":"","type":"uint256[3]"},{"internalType":"uint16[3]","name":"","type":"uint16[3]"},{"internalType":"uint8","name":"","type":"uint8"},{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getFriendsList","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"tokenUri","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"bool","name":"canPlay","type":"bool"}],"internalType":"struct SmartCatProxyV3.CatListItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getLevel","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getPendingInvitesList","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"tokenUri","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"bool","name":"canPlay","type":"bool"}],"internalType":"struct SmartCatProxyV3.CatListItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getPlayInviteIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getPlayInvitesList","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"tokenUri","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"bool","name":"canPlay","type":"bool"}],"internalType":"struct SmartCatProxyV3.CatListItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tokenIds","type":"uint256[]"}],"name":"getPointBalances","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"pointsBalance","type":"uint256"}],"internalType":"struct SmartCatProxyV3.PointsRecord[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getPointsBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_nftContractAddress","type":"address"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"invitee","type":"uint256"}],"name":"inviteCatForPlaying","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"levelAwards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"levelUp","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"maxActionState","outputs":[{"internalType":"uint256","name":"firstActionTimestamp","type":"uint256"},{"internalType":"uint16","name":"count","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxLevel","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"pendingInvites","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"playInvites","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pointBalances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"_authorisedProxyAddresses","type":"address[]"}],"name":"setAuthedProxyAddresses","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"_levelAwards","type":"uint256[]"}],"name":"setLevelAwards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16","name":"_maxActions","type":"uint16"},{"internalType":"uint256","name":"_maxActionsInterval","type":"uint256"}],"name":"setMaxActionConfig","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint8","name":"_maxLevel","type":"uint8"}],"name":"setMaxLevel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[3]","name":"_minIntervals","type":"uint256[3]"}],"name":"setMinIntervals","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint16[3]","name":"_minLevelUpScores","type":"uint16[3]"}],"name":"setMinLevelUpScores","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_nftContractAddress","type":"address"}],"name":"setNftContractAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tokenIds","type":"uint256[]"}],"name":"tokenIdArrayToTokenList","outputs":[{"components":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"tokenUri","type":"string"},{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint8","name":"level","type":"uint8"},{"internalType":"bool","name":"canPlay","type":"bool"}],"internalType":"struct SmartCatProxyV3.CatListItem[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}])  


current_nonce = web3.eth.get_transaction_count(my_wallet_address)

def can_cat_play(cat_id):
    """检查指定猫咪是否可以进行playdate"""
    return contract.functions.canPlay(cat_id).call()

def send_invite(inviter_wallet_address, inviter_private_key, invitee_cat_id, inviter_cat_id, nonce):
    global current_nonce  
    gas_price = web3.eth.gas_price
    increased_gas_price = int(gas_price * 1.3)  
    print(f"Current gas price: {gas_price}, increased gas price: {increased_gas_price}")
    
    txn = contract.functions.inviteCatForPlaying(inviter_cat_id, invitee_cat_id).build_transaction({
            'from': inviter_wallet_address,
            'nonce': nonce,  
            'gas': 150000,  
            'gasPrice': increased_gas_price
    })
    signed_txn = web3.eth.account.sign_transaction(txn, private_key=inviter_private_key)
    tx_hash = web3.eth.send_raw_transaction(signed_txn.rawTransaction)
    print(f"Sent invite from Cat {inviter_cat_id} to Cat {invitee_cat_id}, tx hash: {tx_hash.hex()}")
    current_nonce += 1  
    time.sleep(random.randint(15, 20))  

def send_random_invites(inviter_cats, invitee_cats):
    global current_nonce
    for inviter_cat_id in inviter_cats:
        if can_cat_play(inviter_cat_id):
            invitee_cat_id = random.choice(invitee_cats) 
            send_invite(my_wallet_address, private_key, invitee_cat_id, inviter_cat_id, current_nonce)
        else:
            print(f"Cat {inviter_cat_id} cannot play right now.")
            current_nonce += 1  

send_random_invites(cat_ids, cat_ids_B)